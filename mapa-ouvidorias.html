<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: row;
        height: 100vh;
        margin: 0;
        background-color: #f8f8f8;
      }

      #sidebar {
        width: 30%;
        min-width: 250px;
        max-width: 400px;
        padding: 10px;
        overflow-y: auto;
        background: #f8f8f8;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
      }

      #map {
        flex: 1;
        height: 100%;
        background-color: #f8f8f8;
      }

      #searchPanel {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      #municipioSelect {
        flex: 1;
        padding: 8px;
        font-size: 1rem;
      }

      button {
        padding: 8px 12px;
        font-size: 1rem;
        cursor: pointer;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
      }

      button:hover {
        background-color: #0056b3;
      }

      #infoBox {
        flex-grow: 1;
        overflow-y: auto;
        padding: 10px;
      }

      .map-tooltip {
        font-weight: bold;
        background: white;
        padding: 4px;
        border-radius: 4px;
        box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
      }

      .leaflet-interactive {
        outline: none !important;
      }
    </style>
  </head>
  <body>
    <div id="sidebar">
      <div id="searchPanel">
        <select id="municipioSelect" onchange="searchMunicipio(this.value)">
          <option value="">Selecione um munic√≠pio...</option>
        </select>
        <button onclick="clearSearch()">Limpar</button>
      </div>
      <div id="infoBox">
        <h2>Informa√ß√µes do Munic√≠pio</h2>
        <div id="municipioInfo"></div>
      </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      const MAP_SETTINGS = {
        center: [-5.3, -39.5],
        zoom: 8,
        minZoom: 8,
        maxZoom: 8,
        zoomControl: false,
        dragging: false,
      };

      var map = L.map("map", MAP_SETTINGS);
      var municipiosData = []; // Municipio no Mapa
      var csvData = {}; //Dados do CSV de cada munic√≠pio
      var selectedLayer = null;
      var selectedLayerColor = null;

      fetch(
        "https://raw.githubusercontent.com/TCEOuv/Ouvidorias-Municipais/main/contatos-ouvidorias.csv",
      )
        .then((response) => response.text())
        .then((csv) => {
          Papa.parse(csv, {
            header: true,
            skipEmptyLines: true,
            transformHeader: (header) => header.toLowerCase().trim(),
            complete: function (results) {
              results.data.forEach((row) => {
                const municipio = row.municipio?.trim().toUpperCase();
                const ente = row.ente?.trim() || "N√£o Informado";

                if (!municipio) return;

                if (!csvData[municipio]) {
                  csvData[municipio] = {};
                }

                if (!csvData[municipio][ente]) {
                  csvData[municipio][ente] = [];
                }

                csvData[municipio][ente].push(row);
              });

              loadMap();
            },
          });
        });

      function loadMap() {
        fetch(
          "https://raw.githubusercontent.com/TCEOuv/Ouvidorias-Municipais/main/geojson-municipios-ceara.json",
        )
          .then((response) => response.json())
          .then((data) => {
            L.geoJson(data, {
              style: function (feature) {
                const municipioNome = feature.properties.name.toUpperCase();
                let temOuvidoria = false;

                if (csvData[municipioNome]) {
                  const entidades = Object.values(csvData[municipioNome]);

                  temOuvidoria = entidades.some((dados) => {
                    return dados.length > 0;
                  });
                }

                return {
                  color: "#000",
                  weight: 1,
                  fillColor: temOuvidoria ? "#134383" : "#d3d3d3",
                  fillOpacity: 1.0,
                };
              },
              onEachFeature: function (feature, layer) {
                municipiosData.push({
                  name: feature.properties.name,
                  layer: layer,
                });

                let select = document.getElementById("municipioSelect");
                let option = document.createElement("option");

                option.value = feature.properties.name;
                option.textContent = feature.properties.name;
                select.appendChild(option);

                // Exibe o nome do munic√≠pio ao passar o mouse
                layer.bindTooltip(feature.properties.name, {
                  permanent: false, // Mostra s√≥ ao passar o mouse
                  direction: "center", // Centraliza o nome dentro do munic√≠pio
                  className: "map-tooltip", // Classe CSS para personaliza√ß√£o
                });

                layer.on("click", function () {
                  searchMunicipio(feature.properties.name);
                });
              },
            }).addTo(map);
          });
      }

      function searchMunicipio(selectedMunicipio) {
        if (!selectedMunicipio)
          return alert("Por favor, selecione um munic√≠pio!");
        var municipio = municipiosData.find(
          (m) => m.name === selectedMunicipio,
        );
        if (municipio) {
          if (selectedLayer) {
            selectedLayer.setStyle({
              fillColor: selectedLayerColor,
              weight: 1,
            });
          }
          selectedLayerColor = municipio.layer.options.fillColor;
          municipio.layer.setStyle({ fillColor: "yellow", weight: 3 });
          selectedLayer = municipio.layer;

          const municipioNome = selectedMunicipio.toUpperCase();
          let dadosMunicipio = csvData[municipioNome] || {};

          const entidadesMunicipio = Object.keys(dadosMunicipio);

          if (Object.keys(dadosMunicipio).length === 0) {
            document.getElementById("municipioInfo").innerHTML =
              `<strong>${selectedMunicipio}</strong><br>N√£o h√° registros de ouvidoria.`;
            return;
          }

          let infoHTML = `<strong><h3>${selectedMunicipio}</h3></strong>`;

          Object.keys(dadosMunicipio).forEach((ente) => {
            // Como cada ente √© uma lista, pegamos o primeiro registro [0]
            const d = dadosMunicipio[ente][0];

            infoHTML += `<div style="margin-bottom:10px; border-left: 4px solid #134383; padding-left:10px;">
              <strong>üü¶ ${ente}</strong><br>
              ${d.ouvidor ? `Respons√°vel: ${d.ouvidor}<br>` : ""}
              ${d.email ? `Email: ${d.email}<br>` : ""}
              ${d.telefone ? `Tel: ${d.telefone}<br>` : ""}
              ${d.site ? `<a href="${d.site}" target="_blank">Acesse o Site</a>` : ""}
              </div>`;
          });

          document.getElementById("municipioInfo").innerHTML = infoHTML;
        }
      }

      function clearSearch() {
        document.getElementById("municipioSelect").value = "";
        document.getElementById("municipioInfo").innerHTML = "";
        if (selectedLayer) {
          selectedLayer.setStyle({ fillColor: selectedLayerColor, weight: 1 });
        }
      }
    </script>
  </body>
</html>
