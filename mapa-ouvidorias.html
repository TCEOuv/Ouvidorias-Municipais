<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: row;
        height: 100vh;
        margin: 0;
        background-color: #f8f8f8;
      }

      #not-found-text {
        color: tomato;
      }

      #sidebar {
        width: 30%;
        min-width: 250px;
        max-width: 400px;
        padding: 10px;
        overflow-y: auto;
        background: #f8f8f8;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
      }

      #map {
        flex: 1;
        height: 100%;
        background-color: #f8f8f8;
      }

      #searchPanel {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      #municipioSelect {
        flex: 1;
        padding: 8px;
        font-size: 1rem;
      }

      button {
        padding: 8px 12px;
        font-size: 1rem;
        cursor: pointer;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
      }

      button:hover {
        background-color: #0056b3;
      }

      #infoBox {
        flex-grow: 1;
        overflow-y: auto;
        padding: 10px;
      }

      .ente-card {
        margin-bottom: 15px;
        border-left: 5px solid #134383;
        background: #f9f9f9;
        padding: 10px;
        border-radius: 0 5px 5px 0;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.05);
      }
      .ente-title {
        font-weight: bold;
        color: #134383;
        border-bottom: 1px solid #ddd;
        margin-bottom: 8px;
        padding-bottom: 3px;
      }
      .btn-site {
        display: inline-block;
        margin-top: 10px;
        padding: 5px 10px;
        background: #134383;
        color: white;
        text-decoration: none;
        border-radius: 3px;
        font-size: 0.85em;
      }

      .map-tooltip {
        font-weight: bold;
        background: white;
        padding: 4px;
        border-radius: 4px;
        box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
      }

      .leaflet-interactive {
        outline: none !important;
      }
    </style>
  </head>
  <body>
    <div id="sidebar">
      <div id="searchPanel">
        <select id="municipioSelect" onchange="searchMunicipio(this.value)">
          <option value="">Selecione um munic√≠pio...</option>
        </select>
        <button onclick="clearSearch()">Limpar</button>
      </div>
      <div id="infoBox">
        <h2>Informa√ß√µes do Munic√≠pio</h2>
        <div id="municipioInfo"></div>
      </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      const MAP_SETTINGS = {
        center: [-5.3, -39.5],
        zoom: 8,
        minZoom: 8,
        maxZoom: 8,
        zoomControl: false,
        dragging: false,
      };

      let map = L.map("map", MAP_SETTINGS);
      let geojsonLayer = null;
      let municipiosData = []; // Municipio no Mapa
      let csvData = {}; //Dados do CSV de cada munic√≠pio
      let selectedLayer = null;
      let selectedLayerColor = null;

      fetch(
        "https://raw.githubusercontent.com/TCEOuv/Ouvidorias-Municipais/main/contatos-ouvidorias.csv",
      )
        .then((response) => response.text())
        .then((csv) => {
          Papa.parse(csv, {
            header: true,
            skipEmptyLines: true,
            transformHeader: (header) => header.toLowerCase().trim(),
            complete: function (results) {
              results.data.forEach((row) => {
                const municipio = normalizarTexto(row.municipio);
                const ente = normalizarTexto(row.ente);

                if (!municipio) return;

                if (!csvData[municipio]) {
                  csvData[municipio] = {};
                }

                if (!csvData[municipio][ente]) {
                  csvData[municipio][ente] = [];
                }

                csvData[municipio][ente].push(row);

                console.log(
                  `Municipio: ${municipio}, Ente: ${ente}, Dados:`,
                  row,
                );
              });

              loadMap();
            },
          });
        });

      function loadMap() {
        fetch(
          "https://raw.githubusercontent.com/TCEOuv/Ouvidorias-Municipais/main/geojson-municipios-ceara.json",
        )
          .then((response) => response.json())
          .then((data) => {
            // 1. Criamos a camada GeoJSON
            geojsonLayer = L.geoJson(data, {
              style: function (feature) {
                const municipioMapa = normalizarTexto(feature.properties.name);
                let temOuvidoria = false;

                // Busca o munic√≠pio no csvData (comparando nomes normalizados)
                const chaveMunicipio = Object.keys(csvData).find(
                  (key) => normalizarTexto(key) === municipioMapa,
                );

                if (chaveMunicipio && csvData[chaveMunicipio]) {
                  const dadosMunicipio = csvData[chaveMunicipio];

                  // Crit√©rio: Apenas se houver informa√ß√£o de PREFEITURA
                  const chavePrefeitura = Object.keys(dadosMunicipio).find(
                    (key) => normalizarTexto(key) === "PREFEITURA",
                  );

                  if (chavePrefeitura && dadosMunicipio[chavePrefeitura]) {
                    // Verifica se a lista da prefeitura tem registros
                    temOuvidoria = dadosMunicipio[chavePrefeitura].length > 0;
                  }
                }

                return {
                  color: "#000",
                  weight: 1,
                  fillColor: temOuvidoria ? "#134383" : "#d3d3d3",
                  fillOpacity: 1.0,
                };
              },
              onEachFeature: function (feature, layer) {
                const nomeOriginal = feature.properties.name;
                const nomeNormalizado = normalizarTexto(nomeOriginal);

                // Armazenamento para busca r√°pida (Dicion√°rio)
                municipiosData[nomeNormalizado] = {
                  name: nomeOriginal,
                  layer: layer,
                };

                // Tooltip (Nome do munic√≠pio ao passar o mouse)
                layer.bindTooltip(nomeOriginal, {
                  sticky: true,
                  direction: "auto",
                  className: "map-tooltip",
                });

                // Eventos de Interatividade
                layer.on({
                  mouseover: (e) => {
                    const el = e.target;

                    if (el != selectedLayer) {
                      el.setStyle({
                        weight: 2,
                        color: "#FFF",
                        fillOpacity: 0.8,
                      });
                    }
                  },
                  mouseout: (e) => {
                    if (e.target != selectedLayer) {
                      geojsonLayer.resetStyle(e.target);
                    }
                  },
                  click: () => searchMunicipio(nomeOriginal),
                });
              },
            }).addTo(map);

            // 2. Popula√ß√£o do Select (Otimizada com DocumentFragment)
            popularSelect(data.features);

            // 3. Ajuste de enquadramento (Faz o mapa focar no Cear√°)
            map.fitBounds(geojsonLayer.getBounds());
          })
          .catch((err) => console.error("Erro ao carregar GeoJSON:", err));
      }

      function searchMunicipio(selectedMunicipio) {
        if (!selectedMunicipio) return;

        // 1. Normaliza√ß√£o para garantir o "match" perfeito
        const nomeNormalizado = normalizarTexto(selectedMunicipio);
        const municipioAlvo = municipiosData[nomeNormalizado];

        if (municipioAlvo) {
          const layer = municipioAlvo.layer;

          // 2. L√≥gica de Destaque Visual (Highlight)
          // Se j√° havia um munic√≠pio selecionado, resetamos a cor dele
          if (selectedLayer && geojsonLayer) {
            geojsonLayer.resetStyle(selectedLayer);
          }

          // Guardamos o estado atual e destacamos o novo
          selectedLayer = layer;
          layer.setStyle({
            fillColor: "yellow",
            weight: 3,
            color: "#000",
            fillOpacity: 0.8,
          });

          // 4. Busca e Exibi√ß√£o dos Dados no Painel Lateral
          // Procuramos no csvData usando a chave normalizada
          const chaveCsv = Object.keys(csvData).find(
            (k) => normalizarTexto(k) === nomeNormalizado,
          );
          const dadosMunicipio = csvData[chaveCsv] || {};

          const municipioInfoDiv = document.getElementById("municipioInfo");

          if (Object.keys(dadosMunicipio).length === 0) {
            municipioInfoDiv.innerHTML = `
              <div class="info-header">
                <h3>${selectedMunicipio}</h3>
                <p id="not-found-text">N√£o h√° registros de ouvidoria cadastrados.</p>
              </div>
            `;
            return;
          }

          // Montagem do HTML de informa√ß√µes
          let infoHTML = `<div class="info-header"><h3>${selectedMunicipio}</h3></div>`;

          // Iteramos pelos entes (Prefeitura, C√¢mara, etc.)
          Object.keys(dadosMunicipio).forEach((ente) => {
            const d = dadosMunicipio[ente][0]; // Pegamos o primeiro registro da lista do ente

            infoHTML += `
        <div class="ente-card">
          <div class="ente-title">üü¶ ${ente.toUpperCase()}</div>
          <div class="ente-body">
            ${d.ouvidor ? `<strong>Respons√°vel:</strong> ${d.ouvidor}<br>` : ""}
            ${d.email ? `<strong>Email:</strong> <a href="mailto:${d.email}">${d.email}</a><br>` : ""}
            ${d.telefone ? `<strong>Tel:</strong> ${d.telefone}<br>` : ""}
            ${d.site ? `<a href="${d.site}" target="_blank" class="btn-site">Acessar Portal da Transpar√™ncia</a>` : ""}
          </div>
        </div>`;
          });

          municipioInfoDiv.innerHTML = infoHTML;
        } else {
          console.error(
            "Munic√≠pio n√£o encontrado na base geogr√°fica:",
            nomeNormalizado,
          );
        }
      }

      function clearSearch() {
        document.getElementById("municipioSelect").value = "";
        document.getElementById("municipioInfo").innerHTML = "";

        if (selectedLayer && geojsonLayer) {
          geojsonLayer.resetStyle(selectedLayer);
        }

        selectedLayer = null;
      }

      // Fun√ß√£o auxiliar para popular o select de forma perform√°tica
      function popularSelect(features) {
        const select = document.getElementById("municipioSelect");
        if (!select) return;

        const fragment = document.createDocumentFragment();

        const nomesOrdenados = features
          .map((f) => f.properties.name)
          .sort((a, b) => a.localeCompare(b));

        nomesOrdenados.forEach((nome) => {
          let option = document.createElement("option");
          option.value = nome;
          option.textContent = nome;
          fragment.appendChild(option);
        });

        select.innerHTML =
          '<option value="">Selecione um munic√≠pio...</option>';
        select.appendChild(fragment);
      }

      function normalizarTexto(texto) {
        if (!texto) return "";
        return texto
          .toString()
          .normalize("NFD") // Decomp√µe caracteres acentuados (ex: √° -> a + ¬¥)
          .replace(/[\u0300-\u036f]/g, "") // Remove os acentos
          .toUpperCase() // Tudo em mai√∫sculo
          .trim(); // Remove espa√ßos extras
      }
    </script>
  </body>
</html>
